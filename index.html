<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø¯Ø±Ø³Ø© Ø´. Ù…Ø·Ù„Ú¯ Ø­Ù†ÙˆÙ† - ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ©</title>
<style>
body {
  font-family: "Tahoma";
  background: #f5fff8;
  text-align: center;
  margin: 0;
  padding: 0 10px 40px 10px;
}
header {
  background: #009688;
  color: white;
  padding: 15px;
  border-radius: 0 0 15px 15px;
}
header h1 {margin: 5px 0; font-size: 26px;}
header h2 {margin: 0; font-size: 18px; font-weight: normal;}

.navbar {
  margin: 20px auto;
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}
.navbar button {
  background: #00796b;
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 15px;
  border-radius: 8px;
  cursor: pointer;
}
.navbar button:hover {background: #00695c;}

.section {
  display: none;
  background: #e0f2f1;
  max-width: 900px;
  margin: 18px auto;
  padding: 15px;
  border-radius: 10px;
  text-align: right;
  box-sizing: border-box;
}


input[type="text"], input[type="number"], select, textarea {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #bbb;
  font-size: 15px;
  box-sizing: border-box;
}
textarea {height: 90px;}
.small {width: 48%; display: inline-block; box-sizing: border-box;}
.row {display:flex; gap:8px; justify-content: space-between;}


#teachersList, #studentsList {
  margin-top: 12px;
  background: #fff;
  border-radius: 8px;
  padding: 10px;
  text-align: right;
}
.card {
  border-bottom: 1px solid #ccc;
  padding: 10px 0;
}
.card:last-child {border-bottom: none;}
.card b {font-size: 16px;}


.section button, .small-button {
  background: #00796b;
  color: white;
  border: none;
  padding: 8px 10px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 6px;
}
.small-button {padding:6px 8px; font-size:14px;}
.small-button.gray {background:#607d74;}
.search-box {margin:8px 0;}


#studentPhotoPreview {max-width:120px; border-radius:6px; display:block; margin:6px 0;}


.tag {display:inline-block; background:#c8e6d9; padding:6px 8px; border-radius:12px; margin:4px; font-size:13px;}
.grade-row {display:flex; gap:8px; margin:6px 0;}


@media (max-width:600px){
  .row {flex-direction:column;}
  .small {width:100%;}
}
</style>
</head>
<body>

<header>
  <h1>Ù…Ø¯Ø±Ø³Ø© Ø´. Ù…Ø·Ù„Ú¯ Ø­Ù†ÙˆÙ†</h1>
  <h2>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ©</h2>
</header>

<div class="navbar">
  <button onclick="showSection('teachers')">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</button>
  <button onclick="showSection('management')">ğŸ¢ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
  <button onclick="showSection('students')">ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</button>
  <button onclick="showSection('schoolRecords')">ğŸ“š Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</button>
</div>

<!-- Ù‚Ø³Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†-->
<!--Ø­Ø³ÙŠÙ† Ù„Ù„Ø¨Ø±Ù…Ø¬Ø© ÙŠÙˆØªÙŠÙˆØ¨-->
<div id="teachers" class="section">
  <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h3>

  <div style="text-align:left; margin-bottom:8px;">
    <button class="small-button" onclick="createNewTeacher()">Ø§Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ø±Ø³â•</button>
    <button class="small-button gray" onclick="downloadAllTeachers()">Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</button>
    <button class="small-button" onclick="triggerTeacherImport()">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ø±Ø³</button>
    <button class="small-button" onclick="clearAllTeachers()" style="background:#d32f2f;">ğŸ—‘ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</button>
  </div>

  <div style="background:#dff6f1; padding:10px; border-radius:8px;">
    
    <div style="text-align:right;">
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³</label>
      <input type="text" id="t_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³">
      
      <div class="row">
        <div class="small">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ </label>
          <input type="text" id="t_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        </div>
        <div class="small">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="t_gender">
            <option value="">Ø§Ø®ØªØ± Ø¬Ù†Ø³ Ø§Ù„Ù…Ø¯Ø±Ø³</option>
            <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
            <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
          </select>
        </div>
      </div>

      <label>Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ø²Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³</label>
      <input type="text" id="t_address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">

      <div class="row">
        <div class="small">
          <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø¯Ø±Ø³</label>
          <input type="number" id="t_age" placeholder="Ø¹Ù…Ø± Ø§Ù„Ù…Ø¯Ø±Ø³">
        </div>
        <div class="small">
          <label>Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø°ÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§</label>
          <input type="text" id="t_subject" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø°ÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§">
        </div>
      </div>

      <label>Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø°ÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§</label>
      <div class="row" style="align-items:center;">
        <input type="text" id="t_stage_input" placeholder="Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø°ÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§" class="small">
        <button class="small-button" onclick="addTeacherStage()">Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
      </div>
      <div id="t_stages_list" style="margin-top:6px;"></div>

      <label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³</label>
      <input type="text" id="t_salary" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³ (Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±)" oninput="formatSalaryInput(this)" />

      <label>Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³</label>
      <textarea id="t_bio" placeholder="Ø§Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³"></textarea>

      <div style="text-align:left;">
        <button class="small-button" onclick="saveTeacher()"> Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø±Ø³</button>
        <button class="small-button gray" onclick="clearTeacherForm()"> Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <div class="search-box">
    <input type="text" id="teacherSearch" placeholder=" Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" onkeyup="searchTeachers()" style="width:70%; display:inline-block;">
    <button class="small-button gray" onclick="displayTeachers()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
  </div>

  <div id="teachersList"></div>

  
  <input type="file" id="teacherFileInput" accept=".txt" style="display:none" onchange="importTeacherFile(event)">
</div>

<!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ -->
<div id="students" class="section">
  <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>

  <div style="text-align:left; margin-bottom:8px;">
    <button class="small-button" onclick="createNewStudent()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    <button class="small-button gray" onclick="downloadAllStudents()"> Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙƒÙ…Ù„Ù</button>
    <button class="small-button" onclick="triggerStudentImport()">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ø§Ù„Ø¨ Ù…Ù† Ù…Ù„Ù</button>
    <button class="small-button" onclick="clearAllStudents()" style="background:#d32f2f;">ğŸ—‘ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
  </div>

  <div style="background:#dff6f1; padding:10px; border-radius:8px;">
    <div style="text-align:right;">
      <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ </label>
      <input type="text" id="s_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">

      <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
      <input type="text" id="s_father" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">

      <div class="row">
        <div class="small">
          <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ  ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
          <input type="text" id="s_parent_phone" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±">
        </div>
        <div class="small">
          <label>Ø¹Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input type="number" id="s_age" placeholder="Ø¹Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨">
        </div>
      </div>

      <div class="row">
        <div class="small">
          <label>Ù…ÙˆØ§Ù„ÙŠØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input type="text" id="s_birthdate" placeholder="Ù…ÙˆØ§Ù„ÙŠØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø«Ø§Ù„ 2000/1/1">
        </div>
        <div class="small">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨</label>
          <input type="text" id="s_stage" placeholder="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨">
        </div>
      </div>

      <label>Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ø²Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
      <input type="text" id="s_address" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ø²Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨">

      <label>Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„ØªÙŠ Ø±Ø³Ø¨Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
      <input type="number" id="s_failed_years" placeholder="Ø§ÙƒØªØ¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø±Ù‚Ù…Ø§">

      <label>Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨</label>
      <input type="file" id="s_photo" accept="image/*" onchange="previewStudentPhoto(event)">
      <img id="studentPhotoPreview" src="" alt="" style="display:none;">

      <hr style="border:0.5px solid #cfded9;">

      <!-- Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ -->
      <h4>Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h4>
      <div id="gradesContainer"></div>
      <div class="row" style="align-items:center;">
        <input type="text" id="grade_subject" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="small">
        <input type="number" id="grade_value" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" class="small">
      </div>
      <div style="text-align:left;">
        <button class="small-button" onclick="addGrade()">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø¬Ø©</button>
        <button class="small-button gray" onclick="clearGrades()"> Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
      </div>

      <div style="text-align:left; margin-top:10px;">
        <button class="small-button" onclick="saveStudent()"> Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        <button class="small-button gray" onclick="clearStudentForm()"> Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <div class="search-box">
    <input type="text" id="studentSearch" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨"onkeyup="searchStudents()" style="width:70%; display:inline-block;">
    <button class="small-button gray" onclick="displayStudents()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
  </div>

  <div id="studentsList"></div>


  <input type="file" id="studentFileInput" accept=".txt" style="display:none" onchange="importStudentFile(event)">
</div>


<div id="management" class="section">
  <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
  <p>ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù‡Ù†Ø§.</p>
</div>

<div id="schoolRecords" class="section">
  <h3>Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
  <p>Ù…ÙƒØ§Ù† Ù…Ø®ØµØµ Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆÙ…Ù„ÙØ§ØªÙ‡Ø§.</p>
</div>

<script>
/* ============================
   Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ (ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©)
   ============================ */
let teachers = [];
let tEditIndex = null;

let students = [];
let sEditIndex = null;

/* ============================
   Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† LocalStorage
   ============================ */
function saveTeachersToStorage() {
  localStorage.setItem('school_teachers', JSON.stringify(teachers));
}

function loadTeachersFromStorage() {
  const stored = localStorage.getItem('school_teachers');
  if (stored) {
    teachers = JSON.parse(stored);
  }
}

function saveStudentsToStorage() {
  localStorage.setItem('school_students', JSON.stringify(students));
}

function loadStudentsFromStorage() {
  const stored = localStorage.getItem('school_students');
  if (stored) {
    students = JSON.parse(stored);
  }
}

/* ============================
   ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
   ============================ */
function showSection(id){
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

/* Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† */
showSection('teachers');

/* ============================
   Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø§ØªØ¨ (Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©)
   ============================ */
function formatSalaryInput(el){
  // ØªØ¨Ù‚ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·ØŒ Ø«Ù… ØªØ¶ÙŠÙ Ø§Ù„ÙÙˆØ§ØµÙ„
  let raw = el.value.replace(/[^\d]/g,'');
  if(raw === "") { el.value = ""; return; }
  let withCommas = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  el.value = withCommas;
}

/* Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ø§ØªØ¨ Ù…Ø¹ "Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ" Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶ */
function formatSalaryForDisplay(rawNumberString){
  if(!rawNumberString) return "";
  let num = String(rawNumberString).replace(/[^\d]/g,'');
  if(num==="") return "";
  let withCommas = num.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  return withCommas + " Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ";
}

/* ============================
   Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
   ============================ */
function createNewTeacher(){
  clearTeacherForm();
  tEditIndex = null;
  window.scrollTo({top:0, behavior:'smooth'});
}

function addTeacherStage(){
  let val = document.getElementById('t_stage_input').value.trim();
  if(!val) return;
  const list = document.getElementById('t_stages_list');
  // create tag
  const tag = document.createElement('span');
  tag.className = 'tag';
  tag.innerText = val + ' âœ–';
  tag.onclick = () => { tag.remove(); };
  list.appendChild(tag);
  document.getElementById('t_stage_input').value = '';
}

function getTeacherStagesArray(){
  const container = document.getElementById('t_stages_list');
  let arr = [];
  container.querySelectorAll('.tag').forEach(t => {
    arr.push(t.innerText.replace(' âœ–',''));
  });
  return arr;
}

function setTeacherStagesFromArray(arr){
  const container = document.getElementById('t_stages_list');
  container.innerHTML = '';
  arr.forEach(v => {
    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.innerText = v + ' âœ–';
    tag.onclick = () => { tag.remove(); };
    container.appendChild(tag);
  });
}

function clearTeacherForm(){
  document.getElementById('t_name').value = '';
  document.getElementById('t_phone').value = '';
  document.getElementById('t_address').value = '';
  document.getElementById('t_gender').value = '';
  document.getElementById('t_age').value = '';
  document.getElementById('t_subject').value = '';
  document.getElementById('t_salary').value = '';
  document.getElementById('t_bio').value = '';
  document.getElementById('t_stage_input').value = '';
  document.getElementById('t_stages_list').innerHTML = '';
}

function saveTeacher(){
  // validation: name + phone + gender required
  const name = document.getElementById('t_name').value.trim();
  const phone = document.getElementById('t_phone').value.trim();
  const gender = document.getElementById('t_gender').value;
  if(!name){ alert('âš  Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³'); return; }
  if(!phone){ alert('âš  Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'); return; }
  if(!gender){ alert('âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³ (Ø°ÙƒØ±/Ø£Ù†Ø«Ù‰)'); return; }

  const t = {
    name,
    phone,
    address: document.getElementById('t_address').value.trim(),
    gender,
    age: document.getElementById('t_age').value,
    subject: document.getElementById('t_subject').value.trim(),
    stages: getTeacherStagesArray(),
    salary: document.getElementById('t_salary').value.replace(/[^\d]/g,''),
    bio: document.getElementById('t_bio').value.trim()
  };

  if(tEditIndex !== null){
    // ØªØ¹Ø¯ÙŠÙ„
    teachers[tEditIndex] = t;
    alert('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³');
    tEditIndex = null;
  } else {
    // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø© - Ù†Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© txt ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
    teachers.push(t);
    saveTeacherTxtFile(t);
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ ÙˆØªØ­Ù…ÙŠÙ„Ù‡ ÙƒÙ…Ù„Ù TXT');
  }

  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  saveTeachersToStorage();
  
  displayTeachers();
  clearTeacherForm();
}

/* Ø­ÙØ¸ Ù…Ø¯Ø±Ø³ Ø¨ØµÙŠØºØ© TXT */
function saveTeacherTxtFile(t){
  let data = `Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ: ${t.name}\n` +
             `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${t.phone}\n` +
             `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ø±Ø³: ${t.address}\n` +
             `Ø§Ù„Ø¬Ù†Ø³: ${t.gender}\n` +
             `Ø¹Ù…Ø± Ø§Ù„Ù…Ø¯Ø±Ø³: ${t.age}\n` +
             `Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§: ${t.subject}\n` +
             `Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§: ${t.stages.join(' ØŒ ')}\n` +
             `Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ: ${formatSalaryForDisplay(t.salary)}\n` +
             `Ø§Ù„Ù†Ø¨Ø°Ø©: ${t.bio}\n`;
  let blob = new Blob([data], {type:'text/plain'});
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø§Ø³Ù…
  link.download = `Ù…Ø¯Ø±Ø³_${t.name || 'Ø¨Ø¯ÙˆÙ†_Ø§Ø³Ù…'}.txt`;
  link.click();
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† */
function displayTeachers(list = teachers){
  const div = document.getElementById('teachersList');
  div.innerHTML = '';
  if(list.length === 0){ div.innerHTML = '<p style="color:#666">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø³ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'; return; }
  list.forEach((t, i) => {
    const card = document.createElement('div');
    card.className = 'card';
    let salaryDisplay = t.salary ? formatSalaryForDisplay(t.salary) : '';
    card.innerHTML = `
      <b>${t.name || '-'}</b><br>
      Ù‡Ø§ØªÙ: ${t.phone || '-'}<br>
      Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${t.address || '-'}<br>
      Ø§Ù„Ø¬Ù†Ø³: ${t.gender || '-'} &nbsp; | &nbsp; Ø§Ù„Ø¹Ù…Ø±: ${t.age || '-'}<br>
      Ø§Ù„Ù…Ø§Ø¯Ø©: ${t.subject || '-'}<br>
      Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ${ (t.stages && t.stages.length) ? t.stages.join(' ØŒ ') : '-'}<br>
      Ø§Ù„Ø±Ø§ØªØ¨: ${salaryDisplay}<br>
      Ø§Ù„Ù†Ø¨Ø°Ø©: ${t.bio || '-'}<br>
      <div style="margin-top:6px; text-align:left;">
        <button class="small-button" onclick="editTeacher(${i})">âœ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="small-button gray" onclick="deleteTeacher(${i})">ğŸ—‘ Ø­Ø°Ù</button>
        <button class="small-button" onclick="downloadSingleTeacher(${i})">â¬‡ ØªÙ†Ø²ÙŠÙ„ TXT</button>
      </div>
    `;
    div.appendChild(card);
  });
}

/* ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯Ø±Ø³ */
function editTeacher(i){
  const t = teachers[i];
  document.getElementById('t_name').value = t.name || '';
  document.getElementById('t_phone').value = t.phone || '';
  document.getElementById('t_address').value = t.address || '';
  document.getElementById('t_gender').value = t.gender || '';
  document.getElementById('t_age').value = t.age || '';
  document.getElementById('t_subject').value = t.subject || '';
  document.getElementById('t_salary').value = t.salary ? t.salary.replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '';
  document.getElementById('t_bio').value = t.bio || '';
  setTeacherStagesFromArray(t.stages || []);
  tEditIndex = i;
  window.scrollTo({top:0, behavior:'smooth'});
  alert('âœ Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø¶ØºØ· Ø­ÙØ¸');
}

/* Ø­Ø°Ù */
function deleteTeacher(i){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯Ø±Ø³ØŸ')) return;
  teachers.splice(i,1);
  // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  saveTeachersToStorage();
  displayTeachers();
}

/* Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† */
function clearAllTeachers(){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
  teachers = [];
  saveTeachersToStorage();
  displayTeachers();
  alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†');
}

/* ØªÙ†Ø²ÙŠÙ„ Ù…Ø¯Ø±Ø³ Ù…ÙØ±Ø¯ Ø¨ØµÙŠØºØ© TXT (Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) */
function downloadSingleTeacher(i){
  saveTeacherTxtFile(teachers[i]);
}

/* Ø§Ù„Ø¨Ø­Ø« */
function searchTeachers(){
  const q = document.getElementById('teacherSearch').value.trim().toLowerCase();
  if(!q){ displayTeachers(); return; }
  const filtered = teachers.filter(t => 
    (t.name && t.name.toLowerCase().includes(q)) || (t.phone && t.phone.includes(q))
  );
  displayTeachers(filtered);
}

/* ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ */
function downloadAllTeachers(){
  if(teachers.length === 0){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø³ÙŠÙ† Ù„Ù„Ø­ÙØ¸'); return; }
  let all = '';
  teachers.forEach((t, idx) => {
    all += `--- Ø§Ù„Ù…Ø¯Ø±Ø³ Ø±Ù‚Ù… ${idx+1} ---\n`;
    all += `Ø§Ø³Ù…: ${t.name}\n`;
    all += `Ù‡Ø§ØªÙ: ${t.phone}\n`;
    all += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${t.address}\n`;
    all += `Ø§Ù„Ø¬Ù†Ø³: ${t.gender}\n`;
    all += `Ø§Ù„Ø¹Ù…Ø±: ${t.age}\n`;
    all += `Ø§Ù„Ù…Ø§Ø¯Ø©: ${t.subject}\n`;
    all += `Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ${t.stages.join(' ØŒ ')}\n`;
    all += `Ø§Ù„Ø±Ø§ØªØ¨: ${formatSalaryForDisplay(t.salary)}\n`;
    all += `Ø§Ù„Ù†Ø¨Ø°Ø©: ${t.bio}\n\n`;
  });
  let blob = new Blob([all], {type:'text/plain'});
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Ø¬Ù…ÙŠØ¹_Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†.txt';
  link.click();
}

/* Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ø§Ø³ØªÙŠØ±Ø§Ø¯) Ù…Ø¯Ø±Ø³ Ù…Ù† Ù…Ù„Ù TXT */
function triggerTeacherImport(){
  document.getElementById('teacherFileInput').click();
}
function importTeacherFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const lines = ev.target.result.split('\n');
    const t = {
      name: (lines[0]||'').replace('Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ: ','').trim(),
      phone: (lines[1]||'').replace('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ','').trim(),
      address: (lines[2]||'').replace('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯Ø±Ø³: ','').trim(),
      gender: (lines[3]||'').replace('Ø§Ù„Ø¬Ù†Ø³: ','').trim(),
      age: (lines[4]||'').replace('Ø¹Ù…Ø± Ø§Ù„Ù…Ø¯Ø±Ø³: ','').trim(),
      subject: (lines[5]||'').replace('Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§: ','').trim(),
      stages: ((lines[6]||'').replace('Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙŠ ÙŠØ¯Ø±Ø³Ù‡Ø§: ','').trim().split(' ØŒ ').filter(x=>x)),
      salary: (lines[7]||'').replace('Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ: ','').replace(/[^\d]/g,'').trim(),
      bio: (lines[8]||'').replace('Ø§Ù„Ù†Ø¨Ø°Ø©: ','').trim()
    };
    teachers.push(t);
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    saveTeachersToStorage();
    alert('ğŸ“¥ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³');
    displayTeachers();
  };
  reader.readAsText(file);
}

/* ============================
   Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø·Ù„Ø§Ø¨
   ============================ */
function createNewStudent(){
  clearStudentForm();
  sEditIndex = null;
  window.scrollTo({top:0, behavior:'smooth'});
}

/* Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ */
function previewStudentPhoto(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = document.getElementById('studentPhotoPreview');
    img.src = ev.target.result;
    img.style.display = 'block';
    img.dataset.url = ev.target.result; // Ù†Ø®Ø²Ù† dataURL
  };
  reader.readAsDataURL(file);
}

/* Ø¯Ø±Ø¬Ø§Øª */
function addGrade(){
  const subj = document.getElementById('grade_subject').value.trim();
  const val = document.getElementById('grade_value').value;
  if(!subj){ alert('âš  Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©'); return; }
  if(val === ''){ alert('âš  Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø©'); return; }
  const container = document.getElementById('gradesContainer');
  const row = document.createElement('div');
  row.className = 'grade-row';
  row.innerHTML = `<div style="flex:1"><b>${subj}</b></div><div style="width:100px">${val}</div><div style="width:120px; text-align:left;"><button class="small-button gray" onclick="this.parentElement.parentElement.remove()">Ø­Ø°Ù</button></div>`;
  // Ù†Ø®Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ data attributes
  row.dataset.subj = subj;
  row.dataset.val = val;
  container.appendChild(row);
  document.getElementById('grade_subject').value = '';
  document.getElementById('grade_value').value = '';
}

function clearGrades(){
  document.getElementById('gradesContainer').innerHTML = '';
}

function getGradesArray(){
  const out = [];
  document.querySelectorAll('#gradesContainer .grade-row').forEach(r => {
    out.push({subject: r.dataset.subj, grade: r.dataset.val});
  });
  return out;
}

function setGradesFromArray(arr){
  clearGrades();
  arr.forEach(g => {
    const container = document.getElementById('gradesContainer');
    const row = document.createElement('div');
    row.className = 'grade-row';
    row.dataset.subj = g.subject;
    row.dataset.val = g.grade;
    row.innerHTML = `<div style="flex:1"><b>${g.subject}</b></div><div style="width:100px">${g.grade}</div><div style="width:120px; text-align:left;"><button class="small-button gray" onclick="this.parentElement.parentElement.remove()">Ø­Ø°Ù</button></div>`;
    container.appendChild(row);
  });
}

/* Ø­ÙØ¸ Ø·Ø§Ù„Ø¨ */
function saveStudent(){
  const name = document.getElementById('s_name').value.trim();
  if(!name){ alert('âš  Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'); return; }
  const s = {
    name,
    father: document.getElementById('s_father').value.trim(),
    parent_phone: document.getElementById('s_parent_phone').value.trim(),
    age: document.getElementById('s_age').value,
    birthdate: document.getElementById('s_birthdate').value.trim(),
    stage: document.getElementById('s_stage').value.trim(),
    address: document.getElementById('s_address').value.trim(),
    failed_years: document.getElementById('s_failed_years').value,
    photoDataUrl: document.getElementById('studentPhotoPreview').dataset.url || '',
    grades: getGradesArray()
  };

  if(sEditIndex !== null){
    students[sEditIndex] = s;
    sEditIndex = null;
    alert('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');
  } else {
    students.push(s);
    saveStudentTxtFile(s);
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ­Ù…ÙŠÙ„Ù‡ ÙƒÙ…Ù„Ù TXT');
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  saveStudentsToStorage();
  
  displayStudents();
  clearStudentForm();
}

/* Ø­ÙØ¸ Ø·Ø§Ù„Ø¨ ÙƒÙ…Ù„Ù txt */
function saveStudentTxtFile(s){
  let data = `Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ: ${s.name}\n` +
             `Ø§Ø³Ù… Ø§Ù„Ø§Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ: ${s.father}\n` +
             `Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø§Ù…Ø±: ${s.parent_phone}\n` +
             `Ø¹Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${s.age}\n` +
             `Ù…ÙˆØ§Ù„ÙŠØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ${s.birthdate}\n` +
             `Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©: ${s.stage}\n` +
             `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø²Ù„: ${s.address}\n` +
             `Ø³Ù†ÙˆØ§Øª Ø±Ø³Ø¨Ù‡Ø§: ${s.failed_years}\n` +
             `Ø§Ù„Ø¯Ø±Ø¬Ø§Øª:\n`;
  s.grades.forEach(g => {
    data += `- ${g.subject} : ${g.grade}\n`;
  });
  data += `ØµÙˆØ±Ø©: (ØºÙŠØ± Ù…Ø´Ù…ÙˆÙ„Ø© Ø¨Ø§Ù„Ù…Ù„Ù txt)\n`;
  let blob = new Blob([data], {type:'text/plain'});
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `Ø·Ø§Ù„Ø¨_${s.name || 'Ø¨Ø¯ÙˆÙ†_Ø§Ø³Ù…'}.txt`;
  link.click();
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ */
function displayStudents(list = students){
  const div = document.getElementById('studentsList');
  div.innerHTML = '';
  if(list.length === 0){ div.innerHTML = '<p style="color:#666">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'; return; }
  list.forEach((s, i) => {
    const card = document.createElement('div');
    card.className = 'card';
    let gradesHtml = (s.grades && s.grades.length) ? s.grades.map(g => `${g.subject}: ${g.grade}`).join(' | ') : '-';
    let imgHtml = s.photoDataUrl ? `<img src="${s.photoDataUrl}" style="max-width:80px; display:block; margin:6px 0; border-radius:6px;">` : '';
    card.innerHTML = `
      <b>${s.name || '-'}</b><br>
      Ø§Ù„Ø£Ø¨: ${s.father || '-'}<br>
      ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${s.parent_phone || '-'}<br>
      Ø§Ù„Ø¹Ù…Ø±: ${s.age || '-'} &nbsp; | &nbsp; Ù…ÙˆØ§Ù„ÙŠØ¯: ${s.birthdate || '-'}<br>
      Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${s.stage || '-'} &nbsp; | &nbsp; Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø±Ø³ÙˆØ¨: ${s.failed_years || 0}<br>
      Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${s.address || '-'}<br>
      Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: ${gradesHtml}<br>
      ${imgHtml}
      <div style="margin-top:6px; text-align:left;">
        <button class="small-button" onclick="editStudent(${i})">âœ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="small-button gray" onclick="deleteStudent(${i})">ğŸ—‘ Ø­Ø°Ù</button>
        <button class="small-button" onclick="downloadSingleStudent(${i})">â¬‡ ØªÙ†Ø²ÙŠÙ„ TXT</button>
      </div>
    `;
    div.appendChild(card);
  });
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨ */
function editStudent(i){
  const s = students[i];
  document.getElementById('s_name').value = s.name || '';
  document.getElementById('s_father').value = s.father || '';
  document.getElementById('s_parent_phone').value = s.parent_phone || '';
  document.getElementById('s_age').value = s.age || '';
  document.getElementById('s_birthdate').value = s.birthdate || '';
  document.getElementById('s_stage').value = s.stage || '';
  document.getElementById('s_address').value = s.address || '';
  document.getElementById('s_failed_years').value = s.failed_years || '';
  if(s.photoDataUrl){
    document.getElementById('studentPhotoPreview').src = s.photoDataUrl;
    document.getElementById('studentPhotoPreview').style.display = 'block';
    document.getElementById('studentPhotoPreview').dataset.url = s.photoDataUrl;
  } else {
    document.getElementById('studentPhotoPreview').src = '';
    document.getElementById('studentPhotoPreview').style.display = 'none';
    delete document.getElementById('studentPhotoPreview').dataset.url;
  }
  setGradesFromArray(s.grades || []);
  sEditIndex = i;
  window.scrollTo({top:0, behavior:'smooth'});
  alert('âœ Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø«Ù… Ø¶ØºØ· Ø­ÙØ¸');
}

function deleteStudent(i){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) return;
  students.splice(i,1);
  // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  saveStudentsToStorage();
  displayStudents();
}

/* Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ */
function clearAllStudents(){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
  students = [];
  saveStudentsToStorage();
  displayStudents();
  alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨');
}

function downloadSingleStudent(i){
  saveStudentTxtFile(students[i]);
}

/* Ø¨Ø­Ø« Ø·Ù„Ø§Ø¨ */
function searchStudents(){
  const q = document.getElementById('studentSearch').value.trim().toLowerCase();
  if(!q){ displayStudents(); return; }
  const filtered = students.filter(s => 
    (s.name && s.name.toLowerCase().includes(q)) || (s.parent_phone && s.parent_phone.includes(q))
  );
  displayStudents(filtered);
}

/* ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ */
function downloadAllStudents(){
  if(students.length === 0){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù„Ø­ÙØ¸'); return; }
  let all = '';
  students.forEach((s, idx) => {
    all += `--- Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ù‚Ù… ${idx+1} ---\n`;
    all += `Ø§Ø³Ù…: ${s.name}\n`;
    all += `Ø§Ù„Ø£Ø¨: ${s.father}\n`;
    all += `ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${s.parent_phone}\n`;
    all += `Ø§Ù„Ø¹Ù…Ø±: ${s.age}\n`;
    all += `Ù…ÙˆØ§Ù„ÙŠØ¯: ${s.birthdate}\n`;
    all += `Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${s.stage}\n`;
    all += `Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø±Ø³ÙˆØ¨: ${s.failed_years}\n`;
    all += `Ø§Ù„Ø¯Ø±Ø¬Ø§Øª:\n`;
    s.grades.forEach(g => all += `- ${g.subject}: ${g.grade}\n`);
    all += `\n`;
  });
  let blob = new Blob([all], {type:'text/plain'});
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Ø¬Ù…ÙŠØ¹_Ø§Ù„Ø·Ù„Ø§Ø¨.txt';
  link.click();
}

/* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø·Ø§Ù„Ø¨ */
function triggerStudentImport(){ document.getElementById('studentFileInput').click(); }
function importStudentFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const text = ev.target.result;
    const lines = text.split('\n');
    const s = {
      name: (lines[0]||'').replace('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ: ','').trim(),
      father: (lines[1]||'').replace('Ø§Ø³Ù… Ø§Ù„Ø§Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ: ','').trim(),
      parent_phone: (lines[2]||'').replace('Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø§Ù…Ø±: ','').trim(),
      age: (lines[3]||'').replace('Ø¹Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ','').trim(),
      birthdate: (lines[4]||'').replace('Ù…ÙˆØ§Ù„ÙŠØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ','').trim(),
      stage: (lines[5]||'').replace('Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©: ','').trim(),
      address: (lines[6]||'').replace('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø²Ù„: ','').trim(),
      failed_years: (lines[7]||'').replace('Ø³Ù†ÙˆØ§Øª Ø±Ø³Ø¨Ù‡Ø§: ','').trim(),
      grades: []
    };
    // parsing grades section
    const idx = lines.findIndex(l => l.startsWith('Ø§Ù„Ø¯Ø±Ø¬Ø§Øª:'));
    if(idx >= 0){
      for(let i = idx+1; i < lines.length; i++){
        const ln = lines[i].trim();
        if(!ln) continue;
        const m = ln.replace(/^- /,'').split(':');
        if(m.length >= 2) s.grades.push({subject: m[0].trim(), grade: m[1].trim()});
      }
    }
    students.push(s);
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    saveStudentsToStorage();
    alert('ğŸ“¥ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');
    displayStudents();
  };
  reader.readAsText(file);
}

/* ØªÙ†Ø¸ÙŠÙ ÙÙˆØ±Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ */
function clearStudentForm(){
  document.getElementById('s_name').value = '';
  document.getElementById('s_father').value = '';
  document.getElementById('s_parent_phone').value = '';
  document.getElementById('s_age').value = '';
  document.getElementById('s_birthdate').value = '';
  document.getElementById('s_stage').value = '';
  document.getElementById('s_address').value = '';
  document.getElementById('s_failed_years').value = '';
  document.getElementById('s_photo').value = '';
  document.getElementById('studentPhotoPreview').src = '';
  document.getElementById('studentPhotoPreview').style.display = 'none';
  delete document.getElementById('studentPhotoPreview').dataset.url;
  clearGrades();
}

/* ============================
   ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
   ============================ */
window.onload = function() {
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  loadTeachersFromStorage();
  loadStudentsFromStorage();
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  displayTeachers();
  displayStudents();
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
  showSection('teachers');
};
</script>

</body>
</html>